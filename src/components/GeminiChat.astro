---
---

<div id="gemini-chat-container">
  <button id="gemini-chat-toggle" aria-label="Toggle AI Chat">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </button>

  <div id="gemini-chat-window" class="hidden">
    <div class="chat-header">
      <h3>Chat with Onuralp's AI</h3>
      <button id="gemini-chat-close">&times;</button>
    </div>
    
    <div id="chat-setup-view">
      <p class="warning">
        <strong>Experimental Feature</strong><br>
        This uses Chrome's Built-in AI (Gemini Nano). Activating this may require downloading a ~1.5GB model if it is not already cached in your browser.
      </p>
      <button id="gemini-chat-enable" class="btn">Enable AI Chat</button>
      <p id="chat-status" class="status-msg"></p>
    </div>

    <div id="chat-active-view" class="hidden">
      <div id="chat-messages">
        <div class="msg ai">Hi! I'm Onuralp's AI persona. I can answer questions about his experience, projects, and skills. How can I help?</div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ask me something..." autocomplete="off" />
        <button id="chat-send">Send</button>
      </div>
    </div>
  </div>
</div>

<style>
  #gemini-chat-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    font-family: var(--font-body);
  }

  #gemini-chat-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent-regular);
    color: white;
    border: 1px solid var(--gray-800);
    box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  }
  
  #gemini-chat-toggle:hover {
    transform: scale(1.05);
    background: var(--accent-dark);
    box-shadow: 0 4px 20px rgba(0, 210, 255, 0.4);
  }

  #gemini-chat-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 350px;
    height: 500px;
    max-height: 70vh;
    background: var(--gray-999);
    border: 1px solid var(--gray-800);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    transform-origin: bottom right;
  }

  #gemini-chat-window.hidden {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.95);
  }

  .chat-header {
    background: var(--gray-900);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--gray-800);
  }

  .chat-header h3 {
    margin: 0;
    font-size: var(--text-md);
    color: var(--gray-0);
  }

  #gemini-chat-close {
    background: none;
    border: none;
    color: var(--gray-400);
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }
  
  #gemini-chat-close:hover {
    color: var(--gray-0);
  }

  #chat-setup-view {
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 1.5rem;
    height: 100%;
    justify-content: center;
  }

  .warning {
    font-size: var(--text-sm);
    color: var(--gray-300);
    background: rgba(255, 189, 46, 0.1);
    border: 1px solid rgba(255, 189, 46, 0.3);
    padding: 1rem;
    border-radius: 0.5rem;
  }

  .warning strong {
    color: #ffbd2e;
  }

  .btn {
    background: var(--accent-regular);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 999rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn:hover {
    background: var(--accent-dark);
  }
  
  .btn:disabled {
    background: var(--gray-800);
    color: var(--gray-500);
    cursor: not-allowed;
  }

  .status-msg {
    font-size: var(--text-sm);
    color: var(--gray-400);
    margin: 0;
  }

  #chat-active-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  #chat-active-view.hidden {
    display: none;
  }

  #chat-setup-view.hidden {
    display: none;
  }

  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .msg {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    font-size: var(--text-sm);
    line-height: 1.5;
    word-break: break-word;
  }

  .msg.ai {
    background: var(--gray-800);
    color: var(--gray-200);
    align-self: flex-start;
    border-bottom-left-radius: 0.25rem;
  }

  .msg.user {
    background: var(--accent-regular);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0.25rem;
  }
  
  .msg.error {
    background: rgba(255, 95, 86, 0.1);
    color: #ff5f56;
    border: 1px solid rgba(255, 95, 86, 0.3);
    align-self: center;
    max-width: 95%;
    text-align: center;
  }

  .chat-input-area {
    padding: 1rem;
    background: var(--gray-900);
    border-top: 1px solid var(--gray-800);
    display: flex;
    gap: 0.5rem;
  }

  #chat-input {
    flex: 1;
    background: var(--gray-800);
    border: 1px solid var(--gray-700);
    color: var(--gray-0);
    padding: 0.5rem 1rem;
    border-radius: 999rem;
    font-size: var(--text-sm);
    min-width: 0;
  }

  #chat-input:focus {
    outline: none;
    border-color: var(--accent-regular);
  }

  #chat-send {
    background: var(--accent-regular);
    color: white;
    border: none;
    border-radius: 999rem;
    padding: 0 1rem;
    font-weight: 600;
    cursor: pointer;
    font-size: var(--text-sm);
  }
  
  #chat-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<script>
  let chatSession: any = null;
  let isNewApiSession = false;

  const initializeGeminiChat = () => {
    const toggleBtn = document.getElementById('gemini-chat-toggle');
    const chatWindow = document.getElementById('gemini-chat-window');
    const closeBtn = document.getElementById('gemini-chat-close');
    
    const setupView = document.getElementById('chat-setup-view');
    const activeView = document.getElementById('chat-active-view');
    const enableBtn = document.getElementById('gemini-chat-enable') as HTMLButtonElement | null;
    const statusMsg = document.getElementById('chat-status');
    
    const messagesContainer = document.getElementById('chat-messages');
    const inputField = document.getElementById('chat-input') as HTMLInputElement | null;
    const sendBtn = document.getElementById('chat-send') as HTMLButtonElement | null;

    const setStatus = (text: string, isError = false) => {
      if (!statusMsg) return;
      statusMsg.textContent = text;
      statusMsg.style.color = isError ? '#ff5f56' : 'var(--gray-400)';
    };

    const getLanguageModelApi = () => {
      const hostWindow = window as any;
      // New API (Chrome 128+): window.LanguageModel
      if (typeof hostWindow.LanguageModel !== 'undefined') return hostWindow.LanguageModel;
      // Legacy API: window.ai.languageModel
      if (hostWindow.ai && typeof hostWindow.ai.languageModel !== 'undefined') return hostWindow.ai.languageModel;
      return null;
    };

    const getAvailability = (capabilities: any) => {
      return capabilities?.available ?? capabilities?.availability ?? 'unknown';
    };

    const runDiagnostics = async () => {
      if (!enableBtn) return { ok: false, availability: 'no' as const };

      if (!window.isSecureContext) {
        enableBtn.disabled = true;
        setStatus('Built-in AI requires a secure context (HTTPS or localhost).', true);
        return { ok: false, availability: 'no' as const };
      }

      const languageModel = getLanguageModelApi();
      if (!languageModel) {
        enableBtn.disabled = true;
        setStatus(
          'Chrome Built-in AI API not found. Enable flags: chrome://flags/#optimization-guide-on-device-model and chrome://flags/#prompt-api-for-gemini-nano-multimodal-input, then fully restart Chrome.',
          true
        );
        return { ok: false, availability: 'no' as const };
      }

      // New API uses availability(), old API uses capabilities()
      const hasAvailability = typeof languageModel.availability === 'function';
      const hasCapabilities = typeof languageModel.capabilities === 'function';
      if (!hasAvailability && !hasCapabilities) {
        enableBtn.disabled = true;
        setStatus('LanguageModel API found but availability check is missing. Please update Chrome.', true);
        return { ok: false, availability: 'no' as const };
      }

      try {
        // New API: availability() → string directly ('available','downloading','unavailable')
        // Old API: capabilities() → object with .available ('readily','after-download','no')
        let availability: string;
        if (typeof languageModel.availability === 'function') {
          availability = await languageModel.availability();
        } else {
          const capabilities = await languageModel.capabilities();
          availability = getAvailability(capabilities);
        }

        // 'unavailable' = new API, 'no' = old API
        if (availability === 'unavailable' || availability === 'no') {
          enableBtn.disabled = true;
          setStatus(`Gemini Nano reports unavailable (status: ${availability}). Check chrome://on-device-internals.`, true);
          return { ok: false, availability };
        }

        // 'downloading' = new API, 'after-download' = old API
        if (availability === 'after-download' || availability === 'downloading') {
          enableBtn.disabled = false;
          enableBtn.textContent = 'Download + Enable AI Chat';
          setStatus(`Model is still downloading (status: ${availability}). Keep this tab open and try again soon.`);
          return { ok: true, availability };
        }

        enableBtn.disabled = false;
        enableBtn.textContent = 'Enable AI Chat';
        setStatus(`Gemini Nano is ready ✓ (status: ${availability})`);
        return { ok: true, availability };
      } catch (error: any) {
        enableBtn.disabled = true;
        setStatus(`Availability check failed: ${error?.message || 'unknown error'}`, true);
        return { ok: false, availability: 'no' as const };
      }
    };

    // Toggle Window
    toggleBtn?.addEventListener('click', () => {
      chatWindow?.classList.toggle('hidden');
    });

    closeBtn?.addEventListener('click', () => {
      chatWindow?.classList.add('hidden');
    });

    // Enable AI
    enableBtn?.addEventListener('click', async () => {
      if (!enableBtn) return;

      const diagnostics = await runDiagnostics();
      if (!diagnostics.ok) return;

      const languageModel = getLanguageModelApi();
      if (!languageModel) {
        setStatus('Chrome Built-in AI API not found — re-run diagnostics.', true);
        return;
      }

      try {
        enableBtn.disabled = true;
        setStatus("Fetching Onuralp's context profile...");
        const promptRes = await fetch('/prompt.txt');
        if (!promptRes.ok) throw new Error("Failed to load prompt.txt");
        const systemPrompt = await promptRes.text();

        setStatus('Initializing AI session (first run may take a moment)...');

        // New API uses initialPrompts with role 'system'; old API uses systemPrompt string
        isNewApiSession = typeof languageModel.availability === 'function';
        chatSession = isNewApiSession
          ? await languageModel.create({
              initialPrompts: [{ role: 'system', content: systemPrompt }],
              monitor(m: any) {
                m.addEventListener('downloadprogress', (e: any) => {
                  setStatus(`Downloading model: ${Math.round(e.loaded * 100)}%`);
                });
              },
            })
          : await languageModel.create({ systemPrompt });

        // Switch to active view
        setupView?.classList.add('hidden');
        activeView?.classList.remove('hidden');

      } catch (e: any) {
        console.error(e);
        setStatus('Error initializing AI: ' + e.message, true);
        enableBtn.disabled = false;
      }
    });

    function addMessage(text: string, sender: string) {
      if (!messagesContainer) return;
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      div.textContent = text;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function handleSend() {
      if (!inputField || !sendBtn || !messagesContainer) return;
      const text = inputField.value.trim();
      if (!text || !chatSession) return;

      // Output User Message
      addMessage(text, 'user');
      inputField.value = '';
      
      // Disable inputs
      inputField.disabled = true;
      sendBtn.disabled = true;

      // Create a temporary AI message for streaming wrapper
      const aiMessageDiv = document.createElement('div');
      aiMessageDiv.className = 'msg ai';
      aiMessageDiv.textContent = '...';
      messagesContainer.appendChild(aiMessageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      try {
        if (typeof chatSession.promptStreaming === 'function') {
          const stream = chatSession.promptStreaming(text);
          let fullResponse = '';
          for await (const chunk of stream) {
            // New API: each chunk is a delta to append.
            // Old API: each chunk is the full accumulated response so far.
            fullResponse = isNewApiSession ? fullResponse + chunk : chunk;
            aiMessageDiv.textContent = fullResponse;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        } else {
          const response = await chatSession.prompt(text);
          aiMessageDiv.textContent = response;
        }
      } catch (e: any) {
        console.error(e);
        aiMessageDiv.textContent = "Sorry, I encountered an error: " + e.message;
        aiMessageDiv.classList.add('error');
      }

      // Enable inputs
      inputField.disabled = false;
      sendBtn.disabled = false;
      inputField.focus();
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    sendBtn?.addEventListener('click', handleSend);
    inputField?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSend();
    });

    runDiagnostics();
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGeminiChat, { once: true });
  } else {
    initializeGeminiChat();
  }
</script>
